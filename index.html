<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struktur Wilayah Indonesia (Bootstrap & jQuery)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .list-group-item {
            cursor: pointer;
            margin-bottom: 5px;
            border-radius: 0.25rem !important;
            border-left: 5px solid transparent;
        }
        
        /* Styling per level */
        .provinsi-item { border-left-color: #0d6efd; /* Primary */ background-color: #e9f0ff; }
        .kabupaten-item { border-left-color: #198754; /* Success */ background-color: #f1fff6; margin-left: 15px; }
        .kecamatan-item { border-left-color: #ffc107; /* Warning */ background-color: #fff8e1; margin-left: 30px; }
        
        /* Atur padding dan margin untuk daftar dalam */
        .collapse-container { padding-left: 0; }
        
        /* Agar tombol detail tetap di kanan */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">Struktur Administrasi Wilayah Indonesia ðŸ‡®ðŸ‡©</h2>
    <div id="province-container" class="shadow-sm p-3 bg-white rounded">
        <div class="alert alert-info text-center" id="loading-message">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Mengambil data dari GitHub. Mohon tunggu...
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- URL RAW DATA DARI GITHUB ---
    const PROVINSI_URL = 'https://raw.githubusercontent.com/jackhw94-ai/indonesia-api/main/api/provinsi/provinsi.json';
    const KABUPATEN_URL = 'https://raw.githubusercontent.com/jackhw94-ai/indonesia-api/main/api/kabupaten_kota/kabupaten.json';
    const KECAMATAN_URL = 'https://raw.githubusercontent.com/jackhw94-ai/indonesia-api/main/api/kecamatan/kecamatan.json';

    // --- FUNGSI UTILITY ---
    
    // Fungsi untuk mengelompokkan data menjadi hierarki
    function groupData(provinces, regencies, districts) {
        const hierarchy = {};

        // 1. Inisialisasi Provinsi
        for (const code in provinces) {
            hierarchy[code] = {
                name: provinces[code],
                regencies: {}
            };
        }

        // 2. Kelompokkan Kabupaten/Kota ke dalam Provinsi
        for (const code in regencies) {
            const provCode = code.substring(0, 2);
            if (hierarchy[provCode]) {
                hierarchy[provCode].regencies[code] = {
                    name: regencies[code].name,
                    districts: {}
                };
            }
        }

        // 3. Kelompokkan Kecamatan ke dalam Kabupaten/Kota
        for (const code in districts) {
            const regencyCode = code.substring(0, 4);
            const provCode = code.substring(0, 2);
            
            // Pastikan Provinsi dan Kabupaten/Kota ada sebelum menyisipkan Kecamatan
            if (hierarchy[provCode] && hierarchy[provCode].regencies[regencyCode]) {
                hierarchy[provCode].regencies[regencyCode].districts[code] = districts[code];
            }
        }
        
        return hierarchy;
    }
    
    // Fungsi untuk merender seluruh hierarki menggunakan jQuery
    function renderHierarchy(data) {
        const $container = $('#province-container');
        $container.empty(); // Bersihkan pesan loading
        
        const $ulProvinsi = $('<div class="list-group"></div>'); // Ganti <ul> dengan <div> list-group Bootstrap
        
        // Sortir Provinsi berdasarkan Kode
        const sortedProvCodes = Object.keys(data).sort();

        $.each(sortedProvCodes, function(index, provCode) {
            const province = data[provCode];
            
            // Item Provinsi
            const $liProvinsi = $(`<div class="list-group-item provinsi-item"></div>`);
            
            // Header (Nama + Tombol)
            const $headerProvinsi = $(`<div class="list-header"></div>`);
            $headerProvinsi.append(`<span><strong>${province.name}</strong> (${provCode})</span>`);
            
            // Tombol Detail/Toggle (menggunakan data-bs-toggle="collapse")
            const $buttonProvinsi = $(`
                <button class="btn btn-sm btn-primary" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse-regency-${provCode}" 
                        aria-expanded="false" 
                        aria-controls="collapse-regency-${provCode}">
                    Detail
                </button>
            `);
            $headerProvinsi.append($buttonProvinsi);
            $liProvinsi.append($headerProvinsi);
            
            // Container Collapse untuk Kabupaten/Kota
            const $collapseKabupaten = $(`<div class="collapse collapse-container" id="collapse-regency-${provCode}"></div>`);
            const $ulKabupaten = $('<div class="list-group my-2"></div>');

            // Sortir Kabupaten/Kota berdasarkan Kode
            const sortedRegencyCodes = Object.keys(province.regencies).sort();

            $.each(sortedRegencyCodes, function(index, regencyCode) {
                const regency = province.regencies[regencyCode];

                // Item Kabupaten/Kota
                const $liKabupaten = $(`<div class="list-group-item kabupaten-item"></div>`);
                
                // Header Kabupaten/Kota
                const $headerKabupaten = $(`<div class="list-header"></div>`);
                $headerKabupaten.append(`<span>${regency.name} (${regencyCode})</span>`);
                
                // Tombol Detail/Toggle Kecamatan
                const $buttonKabupaten = $(`
                    <button class="btn btn-sm btn-success" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse-district-${regencyCode}" 
                            aria-expanded="false" 
                            aria-controls="collapse-district-${regencyCode}">
                        Detail
                    </button>
                `);
                $headerKabupaten.append($buttonKabupaten);
                $liKabupaten.append($headerKabupaten);

                // Container Collapse untuk Kecamatan
                const $collapseKecamatan = $(`<div class="collapse collapse-container" id="collapse-district-${regencyCode}"></div>`);
                const $ulKecamatan = $('<div class="list-group my-2"></div>');

                // Sortir Kecamatan berdasarkan Kode
                const sortedDistCodes = Object.keys(regency.districts).sort();

                $.each(sortedDistCodes, function(index, distCode) {
                    const districtName = regency.districts[distCode];

                    // Item Kecamatan
                    const $liKecamatan = $(`<div class="list-group-item kecamatan-item"><span>${districtName} (${distCode})</span></div>`);

                    $ulKecamatan.append($liKecamatan);
                });

                $collapseKecamatan.append($ulKecamatan);
                $liKabupaten.append($collapseKecamatan);
                $ulKabupaten.append($liKabupaten);
            });
            
            $collapseKabupaten.append($ulKabupaten);
            $liProvinsi.append($collapseKabupaten);
            $ulProvinsi.append($liProvinsi);
        });

        $container.append($ulProvinsi);
        
        // --- JQUERY: Update Teks Tombol Setelah Collapse ---
        // Memastikan teks tombol berubah saat detail dibuka/ditutup
        $('.btn[data-bs-toggle="collapse"]').on('hidden.bs.collapse', function () {
            $(this).text('Detail');
        });
        $('.btn[data-bs-toggle="collapse"]').on('shown.bs.collapse', function () {
            $(this).text('Sembunyikan');
        });
    }
    
    // --- FUNGSI UTAMA: MENGAMBIL DAN MEMPROSES DATA ---
    async function fetchDataAndRender() {
        try {
            // Ambil data secara paralel menggunakan fetch API
            const [resProvinsi, resKabupaten, resKecamatan] = await Promise.all([
                fetch(PROVINSI_URL),
                fetch(KABUPATEN_URL),
                fetch(KECAMATAN_URL)
            ]);

            const dataProvinsi = await resProvinsi.json();
            const dataKabupaten = await resKabupaten.json();
            const dataKecamatan = await resKecamatan.json();
            
            // --- Transformasi Data ---
            
            // 1. Provinsi: dari array data menjadi { code: name }
            const provincesMap = dataProvinsi.data.reduce((acc, item) => {
                acc[item.code] = item.name;
                return acc;
            }, {});
            
            // 2. Kabupaten/Kota: dari array data menjadi { code: { name: '...', provinceCode: '...' } }
            const regenciesMap = dataKabupaten.data.reduce((acc, item) => {
                acc[item.code] = {
                    name: item.name,
                    provinceCode: item.code.substring(0, 2)
                };
                return acc;
            }, {});

            // 3. Kecamatan: langsung ambil dari 'sample_data' (berisi key-value pair kode: nama)
            // Asumsi struktur data Kecamatan sama dengan yang sebelumnya Anda upload
            const districtsMap = dataKecamatan.sample_data;
            
            // 4. Kelompokkan dan Render
            const consolidatedHierarchy = groupData(
                provincesMap,
                regenciesMap,
                districtsMap
            );
            
            renderHierarchy(consolidatedHierarchy);

        } catch (error) {
            console.error('Gagal mengambil atau memproses data:', error);
            $('#province-container').html(`
                <div class="alert alert-danger text-center">
                    Gagal memuat data. Periksa konsol browser untuk detail error.
                </div>
            `);
        }
    }
    
    // Eksekusi fungsi utama setelah dokumen siap
    $(document).ready(function() {
        fetchDataAndRender();
    });

</script>

</body>
</html>