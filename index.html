<script>
    // API lokal
    const API_URL = "/api/index.php";

    let allData = {};
    let currentSearchTerm = '';

    // --- UTIL FUNCTION ---
    function groupData(provinces, regencies, districts) {
        const hierarchy = {};

        // Provinsi
        provinces.forEach(p => {
            hierarchy[p.code] = {
                name: p.name,
                regencies: {}
            };
        });

        // Kabupaten
        regencies.forEach(r => {
            const provCode = r.provinsi_code;
            if (hierarchy[provCode]) {
                hierarchy[provCode].regencies[r.code] = {
                    name: r.name,
                    districts: {}
                };
            }
        });

        // Kecamatan
        districts.forEach(d => {
            const kabCode = d.kabupaten_code;
            const provCode = kabCode.substring(0, 2);

            if (hierarchy[provCode] &&
                hierarchy[provCode].regencies[kabCode]) {
                hierarchy[provCode].regencies[kabCode].districts[d.code] = d.name;
            }
        });

        return hierarchy;
    }

    function updateStats(data) {
        let provinceCount = Object.keys(data).length;
        let regencyCount = 0;
        let districtCount = 0;

        for (const prov in data) {
            regencyCount += Object.keys(data[prov].regencies).length;

            for (const reg in data[prov].regencies) {
                districtCount += Object.keys(data[prov].regencies[reg].districts).length;
            }
        }

        animateCount('province-count', provinceCount);
        animateCount('regency-count', regencyCount);
        animateCount('district-count', districtCount);
    }

    function animateCount(id, target) {
        const elem = document.getElementById(id);
        let cur = 0;
        const step = target / 30;

        let timer = setInterval(() => {
            cur += step;
            if (cur >= target) {
                elem.innerText = target.toLocaleString();
                clearInterval(timer);
            } else {
                elem.innerText = Math.floor(cur).toLocaleString();
            }
        }, 30);
    }

    // --- RENDER LIST HIERARKI ---
    function renderHierarchy(data, search = "") {
        const $container = $('#province-container');
        $container.html("").addClass("fade-in");

        const filtered = search ? filterData(data, search) : data;

        if (Object.keys(filtered).length === 0) {
            $container.html(`
                <div class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Tidak ada hasil</p>
                </div>
            `);
            return;
        }

        const $provList = $('<div class="list-group"></div>');

        Object.keys(filtered).sort().forEach(provCode => {
            const prov = filtered[provCode];

            const $provItem = $(`
                <div class="list-group-item provinsi-item">
                    <div class="list-header">
                        <span>
                            <strong>${highlight(prov.name, search)}</strong>
                            <span class="badge bg-primary ms-2">${provCode}</span>
                            <small class="text-muted d-block mt-1">
                                ${Object.keys(prov.regencies).length} Kabupaten/Kota
                            </small>
                        </span>
                        <button class="btn btn-sm btn-toggle btn-primary" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#kab-${provCode}">
                            <i class="fas fa-chevron-down"></i> Detail
                        </button>
                    </div>
                    <div class="collapse mt-2" id="kab-${provCode}"></div>
                </div>
            `);

            const $kabList = $('<div class="list-group"></div>');

            Object.keys(prov.regencies).sort().forEach(kabCode => {
                const kab = prov.regencies[kabCode];

                const $kabItem = $(`
                    <div class="list-group-item kabupaten-item">
                        <div class="list-header">
                            <span>
                                ${highlight(kab.name, search)}
                                <span class="badge bg-success ms-2">${kabCode}</span>
                                <small class="text-muted d-block mt-1">
                                    ${Object.keys(kab.districts).length} Kecamatan
                                </small>
                            </span>
                            <button class="btn btn-sm btn-toggle btn-success" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#kec-${kabCode}">
                                <i class="fas fa-chevron-down"></i> Detail
                            </button>
                        </div>
                        <div class="collapse mt-2" id="kec-${kabCode}"></div>
                    </div>
                `);

                const $kecList = $('<div class="list-group"></div>');

                Object.keys(kab.districts).sort().forEach(kecCode => {
                    const name = kab.districts[kecCode];

                    $kecList.append(`
                        <div class="list-group-item kecamatan-item">
                            ${highlight(name, search)}
                            <span class="badge bg-warning text-dark ms-2">${kecCode}</span>
                        </div>
                    `);
                });

                $kabItem.find(`#kec-${kabCode}`).append($kecList);
                $kabList.append($kabItem);
            });

            $provItem.find(`#kab-${provCode}`).append($kabList);
            $provList.append($provItem);
        });

        $container.append($provList);
    }

    function highlight(text, search) {
        if (!search) return text;
        return text.replace(new RegExp(search, "gi"), m => `<mark>${m}</mark>`);
    }

    function filterData(data, search) {
        const result = {};
        const term = search.toLowerCase();

        for (const prov in data) {
            const p = data[prov];

            const matchProv = p.name.toLowerCase().includes(term);

            const regFiltered = {};
            for (const reg in p.regencies) {
                const r = p.regencies[reg];

                const matchReg = r.name.toLowerCase().includes(term);

                const distFiltered = {};
                for (const dist in r.districts) {
                    const dname = r.districts[dist];
                    if (dname.toLowerCase().includes(term)) {
                        distFiltered[dist] = dname;
                    }
                }

                if (matchReg || Object.keys(distFiltered).length > 0) {
                    regFiltered[reg] = {
                        ...r,
                        districts: distFiltered
                    };
                }
            }

            if (matchProv || Object.keys(regFiltered).length > 0) {
                result[prov] = { ...p, regencies: regFiltered };
            }
        }

        return result;
    }

    // --- AMBIL DATA DARI API LOKAL ---
    async function loadLocalAPI() {
        try {
            const [p, k, c] = await Promise.all([
                fetch(`${API_URL}?endpoint=provinsi`).then(res => res.json()),
                fetch(`${API_URL}?endpoint=kabupaten`).then(res => res.json()),
                fetch(`${API_URL}?endpoint=kecamatan`).then(res => res.json())
            ]);

            allData = groupData(p, k, c);

            updateStats(allData);
            renderHierarchy(allData);

        } catch (e) {
            console.error(e);
            $('#province-container').html(`
                <div class="alert alert-danger">Gagal memuat API lokal!</div>
            `);
        }
    }

    // --- INIT ---
    $(document).ready(function () {
        loadLocalAPI();

        $("#search-input").on("input", function () {
            renderHierarchy(allData, $(this).val());
        });
    });
</script>
